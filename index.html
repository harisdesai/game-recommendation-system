<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Game Navigator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Constants
        const TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const IMAGE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=";
        const GEN_API_KEY = "AIzaSyDKgN0eDqenlPFNR5fwddmaaH1TEK7hZBQ"; // Provided by Canvas
        const SYSTEM_PROMPT = "Act as a specialized AI game recommender. Your purpose is to provide a list of three diverse and compelling game titles based on a user's free-form preferences. Your output MUST be a single, valid JSON array of objects, with each object having the following structure: { 'game_title': '...', 'description': 'A very brief, one-sentence description, a maximum of 10 words.', 'system_requirements': 'A single, concise sentence listing only the key components (e.g., 'Requires a modern CPU, 8GB RAM, and a GTX 970 GPU').', 'platforms': '...' }";
        const MAX_SYSTEM_REQ_LENGTH = 120; // Maximum character length for system requirements
        const LOADING_MESSAGES = [
            "Scanning the digital universe...",
            "Consulting the AI core...",
            "Calculating optimal recommendations...",
            "Decrypting galactic data streams...",
            "Fine-tuning the algorithm..."
        ];

        // UI elements
        const form = document.getElementById('recommendation-form');
        const recommendBtn = document.getElementById('recommend-btn');
        const buttonText = document.getElementById('button-text');
        const resultsContainer = document.getElementById('recommendation-results');
        const loadingSpinner = document.getElementById('loading-spinner');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let lastUserPrompt = null;
        let loadingInterval = null;
        const API_TIMEOUT = 20000; // 20 seconds timeout for the API call

        // Functions
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }

        async function fetchGameImage(gameTitle) {
            const prompt = `${gameTitle} video game cover art, futuristic, epic, cinematic, vibrant, detailed digital art`;
            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
            
            try {
                const response = await fetch(`${IMAGE_API_URL}${GEN_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
            } catch (error) {
                console.error("Error fetching image:", error);
            }
            return 'https://placehold.co/400x225/2d3748/ffffff?text=Image+Not+Found';
        }

        // --- AI Recommendation Logic (Prompt-Based) ---
        async function getRecommendation(userQuery, isShuffle = false) {
            // Update UI for loading state
            loadingSpinner.classList.remove('hidden');
            recommendBtn.disabled = true;
            let messageIndex = 0;
            buttonText.textContent = LOADING_MESSAGES[messageIndex];
            loadingInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % LOADING_MESSAGES.length;
                buttonText.textContent = LOADING_MESSAGES[messageIndex];
            }, 1000);
            
            // Store the last valid prompt for the shuffle button
            lastUserPrompt = userQuery;

            // To ensure new results on shuffle, we append a unique ID to the prompt.
            // This makes the AI treat it as a new request.
            let uniquePrompt = userQuery;
            if (isShuffle) {
                uniquePrompt += ` - unique_id:${Date.now()}`;
            }

            // Payload for the AI Studio API call
            const payload = {
                contents: [{ parts: [{ text: uniquePrompt }] }],
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                generationConfig: {
                    // This configuration ensures the response is a structured JSON array
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                game_title: { type: "STRING" },
                                description: { type: "STRING" },
                                system_requirements: { type: "STRING" },
                                platforms: { type: "STRING" }
                            }
                        }
                    }
                }
            };

            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), API_TIMEOUT);

            try {
                // Fetch the recommendation from the API with a timeout
                const response = await fetch(`${TEXT_API_URL}${GEN_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(id);

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    displayRecommendations(parsedJson);
                } else {
                    showModal("Failed to get a recommendation. The AI did not provide a valid response.");
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    showModal("The request took too long. Please try again or refine your query.");
                } else {
                    console.error("Error during API call:", error);
                    showModal("Network error or invalid response. Please check your connection and try again.");
                }
            } finally {
                // Reset UI state
                clearInterval(loadingInterval);
                loadingSpinner.classList.add('hidden');
                recommendBtn.disabled = false;
                buttonText.textContent = "SCAN FOR RECOMMENDATIONS";
            }
        }

        async function displayRecommendations(games) {
            resultsContainer.innerHTML = `
                <div class="p-6 rounded-2xl shadow-xl border-4 border-cyan-400 animate-fade-in-up">
                    <h2 class="text-2xl sm:text-3xl font-bold text-cyan-300 mb-4 text-center font-orbitron">Recommended Galactic Adventures:</h2>
                    <ul class="space-y-6">
                        ${games.map(game => {
                            // Sanitize the data to prevent bugs
                            const title = game.game_title || "Unknown Title";
                            const description = game.description || "Description not available.";
                            let systemReq = game.system_requirements || "System requirements not available.";

                            // Truncate system requirements if they are too long
                            if (systemReq.length > MAX_SYSTEM_REQ_LENGTH) {
                                systemReq = systemReq.substring(0, MAX_SYSTEM_REQ_LENGTH) + '...';
                            }

                            const platforms = game.platforms || "Platforms not available.";

                            return `
                                <li class="p-6 bg-slate-700 rounded-xl text-white shadow-lg border border-slate-600 transition-transform transform hover:scale-105">
                                    <div class="mb-4 aspect-video bg-slate-600 rounded-lg flex items-center justify-center relative">
                                        <div class="image-spinner w-8 h-8 border-4 border-cyan-400 border-dotted rounded-full animate-spin border-t-transparent absolute"></div>
                                        <img data-title="${title}" src="" alt="${title}" class="w-full h-full object-cover rounded-lg hidden">
                                    </div>
                                    <h3 class="text-xl sm:text-2xl text-cyan-200 font-bold mb-2">${title}</h3>
                                    <p class="text-gray-300 text-sm mb-4">${description}</p>
                                    <div class="text-xs text-gray-400 space-y-1">
                                        <p class="font-semibold text-gray-200">Platforms: <span class="font-normal text-gray-400">${platforms}</span></p>
                                        <p class="font-semibold text-gray-200">System Requirements: <span class="font-normal text-gray-400">${systemReq}</span></p>
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                    <div class="flex justify-center mt-6">
                        <button id="shuffle-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-slate-800">
                            Shuffle
                        </button>
                    </div>
                </div>
            `;
            const shuffleBtn = document.getElementById('shuffle-btn');
            shuffleBtn.addEventListener('click', () => {
                if (lastUserPrompt) {
                    getRecommendation(lastUserPrompt, true);
                } else {
                    showModal("Please perform a scan first before shuffling.");
                }
            });

            // Fetch and display images asynchronously
            const imageElements = document.querySelectorAll('img[data-title]');
            imageElements.forEach(async (img) => {
                const title = img.getAttribute('data-title');
                const spinner = img.previousElementSibling;
                const imageUrl = await fetchGameImage(title);
                img.src = imageUrl;
                img.classList.remove('hidden');
                spinner.classList.add('hidden');
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const userPrompt = document.getElementById('user-prompt').value;

                if (!userPrompt) {
                    showModal("Please enter your preferences to initiate the scan.");
                    return;
                }
                getRecommendation(userPrompt);
            });

            modalCloseBtn.addEventListener('click', hideModal);
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        /* Animation for fade-in effect */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-fade-in-up {
            animation: fadeInScale 0.6s ease-out forwards;
        }

        .image-spinner {
            border-top-color: #38bdf8;
            border-right-color: transparent;
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center border-2 border-slate-600">
            <p id="modal-message" class="text-gray-100 text-lg mb-4"></p>
            <button id="modal-close-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-full shadow-md transition-colors">OK</button>
        </div>
    </div>

    <div class="w-full max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-600 font-orbitron drop-shadow-lg">
                Galactic Game Navigator
            </h1>
            <p class="text-sm sm:text-base text-gray-400 mt-2">Your personal AI companion for cosmic game discovery.</p>
        </header>

        <main class="flex flex-col gap-8 lg:gap-12">
            <!-- Recommendation Form Section -->
            <section class="bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl border-2 border-slate-700">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-100 font-orbitron">Initiate Scan</h2>
                <form id="recommendation-form" class="space-y-6">
                    <div>
                        <label for="user-prompt" class="block text-sm font-medium text-gray-300 mb-2">Describe your desired game:</label>
                        <input type="text" id="user-prompt" placeholder="e.g., 'a relaxing sci-fi puzzle game for PC'" class="w-full p-3 rounded-lg bg-slate-700 text-gray-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-colors">
                    </div>
                    <button id="recommend-btn" type="submit" class="w-full mt-6 py-4 px-6 bg-gradient-to-r from-cyan-500 to-indigo-600 hover:from-cyan-600 hover:to-indigo-700 text-white font-bold rounded-full shadow-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-slate-800 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="button-text">SCAN FOR RECOMMENDATIONS</span>
                    </button>
                    <div id="loading-spinner" class="hidden flex justify-center items-center mt-4">
                        <div class="w-10 h-10 border-4 border-cyan-400 border-dotted rounded-full animate-spin border-t-transparent"></div>
                    </div>
                </form>
            </section>

            <!-- Results Section -->
            <section class="bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl border-2 border-slate-700">
                <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-100 font-orbitron">Scan Results</h2>
                <div id="recommendation-results" class="text-center text-gray-400 italic">
                    <p>AI awaits your command... Initiate scan to find your next adventure!</p>
                </div>
            </section>
        </main>
    </div>
</body>
</html>

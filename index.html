<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Suggester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09;
            color: #d1d5db;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #1c1917;
            padding: 2.5rem;
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            border: 1px solid #292524;
        }
        .message-box {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #44403c;
            color: #fff;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .result-card, .history-card {
            background-color: #292524;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid #44403c;
        }
        .result-card:hover, .history-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }
        .result-card {
            opacity: 0;
            animation: fadeIn 0.8s forwards;
            animation-delay: 0.2s;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        h1, h2 {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl sm:text-5xl font-bold text-center text-amber-500">Game Suggester</h1>
        <p id="userIdDisplay" class="text-xs text-center text-gray-500 break-all -mt-4"></p>
        
        <div class="space-y-6">
            <textarea
                id="promptInput"
                class="w-full h-36 p-5 text-stone-200 bg-stone-900 border border-stone-800 rounded-2xl focus:outline-none focus:ring-2 focus:ring-amber-500 placeholder-stone-400 resize-none transition-all duration-300 shadow-inner"
                placeholder="Describe the game you're in the mood for. For example: 'A stylish detective game with a noir theme' or 'A relaxing game where I can build things without pressure.'"></textarea>
            
            <button
                id="suggestBtn"
                class="w-full px-6 py-4 font-semibold text-white bg-amber-600 rounded-2xl hover:bg-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-stone-900 transition-all duration-300 shadow-lg hover:shadow-xl">
                Suggest Games
            </button>
        </div>

        <div id="loadingIndicator" class="hidden text-center text-base font-medium text-stone-400">
            <svg class="animate-spin h-6 w-6 mr-3 inline text-amber-500" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating suggestions...
        </div>

        <div id="results" class="space-y-4">
            <h2 class="text-2xl font-semibold text-stone-100">Suggestions</h2>
            <div id="suggestionsList" class="p-2">
                <p class="text-stone-400 text-sm italic">Suggestions will appear here after you describe what you'd like to play.</p>
            </div>
            <button id="whatsappShareBtn" class="hidden w-full px-6 py-4 font-semibold text-white bg-green-600 rounded-2xl hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-stone-900 transition-all duration-300 shadow-lg hover:shadow-xl">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12.03 2.03C6.545 2.03 2.08 6.51 2.02 11.97l-.01 2.05L2 14.07l-1.99 7.02 7.2-.21c1.9.89 4.08 1.34 6.27 1.34h.01c5.485 0 9.95-4.48 9.97-9.97C22.02 6.5 17.55 2.03 12.03 2.03zM16.14 15.65c-.15.25-.43.34-.69.34-.18 0-.35-.06-.5-.18-.32-.26-.74-.43-1.07-.43-.33 0-.64.17-.95.43-.31.26-.65.43-.99.43-.34 0-.68-.17-1.01-.43-.33-.26-.64-.43-.98-.43-.34 0-.68.17-1.02.43-.34.26-.67.43-1.01.43-.18 0-.35-.06-.5-.18-.28-.23-.48-.52-.52-.82-.04-.3-.02-.6.04-.9.23-.74.67-1.4 1.25-1.92l.01-.01c.58-.52 1.26-1 1.95-1.3l.01-.01c.69-.3 1.4-.44 2.15-.44h.01c.75 0 1.46.14 2.15.44l.01.01c.69.3 1.37.78 1.95 1.3l.01.01c.58.52 1.02 1.18 1.25 1.92.06.3.08.6.04.9-.04.3-.24.59-.52.82-.15.12-.32.18-.5.18-.26 0-.54-.09-.69-.34z"/>
                    </svg>
                    <span>Share on WhatsApp</span>
                </div>
            </button>
        </div>

        <div id="previousSuggestions" class="space-y-4">
            <h2 class="text-2xl font-semibold text-stone-100">Previous Suggestions</h2>
            <div id="historyList" class="p-2 space-y-4">
                <p class="text-stone-400 text-sm italic">Your past suggestions will be loaded here.</p>
            </div>
        </div>
    </div>
    <div id="messageBox" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof _firebase_config !== 'undefined' ? JSON.parse(_firebase_config) : {};

        let db;
        let auth;
        let userId = '';
        let isAuthReady = false;

        const promptInput = document.getElementById('promptInput');
        const suggestBtn = document.getElementById('suggestBtn');
        const whatsappShareBtn = document.getElementById('whatsappShareBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const suggestionsList = document.getElementById('suggestionsList');
        const historyList = document.getElementById('historyList');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageBox = document.getElementById('messageBox');

        // Function to show a temporary message
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Firebase Initialization and Auth
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        signInAnonymously(auth).then(() => {
            isAuthReady = true;
            userId = auth.currentUser.uid;
            userIdDisplay.textContent = User ID: ${userId};
            setupHistoryListener();
        }).catch((error) => {
            console.error("Firebase Auth Error:", error);
            showMessage("Failed to authenticate. Please try again.");
        });

        // Function to fetch and display previous suggestions
        function setupHistoryListener() {
            if (!isAuthReady) {
                console.error("Auth not ready. Cannot set up history listener.");
                return;
            }
            const historyRef = collection(db, artifacts/${appId}/users/${userId}/game_suggestions);
            
            // Note: Firebase security rules are set up to handle lack of orderBy
            const q = query(historyRef);
            
            onSnapshot(q, (snapshot) => {
                const suggestions = [];
                snapshot.forEach((doc) => {
                    suggestions.push(doc.data());
                });

                // Sort the data in memory by timestamp in descending order
                suggestions.sort((a, b) => b.timestamp - a.timestamp);

                if (suggestions.length === 0) {
                    historyList.innerHTML = '<p class="text-stone-400 text-sm italic">No previous suggestions found.</p>';
                    return;
                }

                historyList.innerHTML = '';
                suggestions.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'history-card';
                    const promptText = item.prompt ? <strong class="text-stone-300">Prompt:</strong> ${item.prompt} : '';
                    const timestamp = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                    
                    card.innerHTML = `
                        <p class="text-stone-300 text-sm mb-2">${promptText}</p>
                        <p class="text-stone-200 mt-2 whitespace-pre-wrap">${item.suggestion}</p>
                        <p class="text-stone-500 text-xs mt-3">${timestamp}</p>
                    `;
                    historyList.appendChild(card);
                });
            }, (error) => {
                console.error("Firestore Error:", error);
                showMessage("Failed to load history. Check the console.");
            });
        }

        // Handle WhatsApp share
        whatsappShareBtn.addEventListener('click', () => {
            const suggestionText = suggestionsList.querySelector('p')?.textContent;
            if (!suggestionText) {
                showMessage("Nothing to share yet!");
                return;
            }

            const message = Check out these game suggestions I got from the Game Suggester app:\n\n${suggestionText}\n\n;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = https://wa.me/?text=${encodedMessage};
            window.open(whatsappUrl, '_blank');
        });

        // Handle button click
        suggestBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showMessage("Please enter a prompt to get a suggestion.");
                return;
            }

            if (!isAuthReady) {
                 showMessage("Application is still loading. Please wait a moment.");
                 return;
            }

            suggestBtn.disabled = true;
            whatsappShareBtn.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            suggestionsList.innerHTML = '<p class="text-stone-400 text-sm italic">Generating suggestions...</p>';

            try {
                const payload = {
                    contents: [{ parts: [{ text: You are a helpful assistant for suggesting games. Based on the user's prompt, suggest 10-15 games. Please format the response as a numbered list with the game name in bold and a short description for each, ensuring proper line spacing between each entry. Do not limit the response. The user's prompt is: "${prompt}" }] }],
                    model: "gemini-2.5-flash-preview-05-20"
                };

                const apiKey = "AIzaSyDKgN0eDqenlPFNR5fwddmaaH1TEK7hZBQ";
                const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey};

                let response;
                let retryCount = 0;
                const maxRetries = 3;
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) {
                            break; // Success!
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                    }
                    retryCount++;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                }

                if (!response || !response.ok) {
                     throw new Error(API request failed with status ${response ? response.status : 'unknown'});
                }

                const result = await response.json();
                const suggestionText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (suggestionText) {
                    suggestionsList.innerHTML = <div class="result-card"><p class="text-stone-200 whitespace-pre-wrap">${suggestionText}</p></div>;
                    whatsappShareBtn.classList.remove('hidden');
                    
                    // Save to Firestore
                    const newSuggestion = {
                        prompt: prompt,
                        suggestion: suggestionText,
                        timestamp: new Date()
                    };
                    await addDoc(collection(db, artifacts/${appId}/users/${userId}/game_suggestions), newSuggestion);
                    showMessage("Suggestions saved!");

                } else {
                    suggestionsList.innerHTML = '<p class="text-stone-400 text-sm italic">Could not generate suggestions. Please try a different prompt.</p>';
                    showMessage("Failed to get a suggestion. Try again.");
                }

            } catch (error) {
                console.error("API or Firestore error:", error);
                suggestionsList.innerHTML = <p class="text-red-400 text-sm">An error occurred: ${error.message}</p>;
                showMessage("An unexpected error occurred.");
            } finally {
                suggestBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
